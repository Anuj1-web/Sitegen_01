<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library Admin - Sitegen</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background: #f9fafb; color: #111827; }
    .btn { background: black; color: white; padding: 0.5rem 1rem; border-radius: 0.25rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .btn:hover { opacity: 0.8; }
    .card-img { width: 100%; height: 150px; object-fit: cover; border-radius: 0.5rem; }
    h3 { margin-top: 2rem; margin-bottom: 0.5rem; }
    .btn-red { background: #dc2626; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; margin-top: 0.5rem; }
    .btn-red:hover { background: #b91c1c; }
  </style>
</head>
<body class="p-6">

  <h1 class="text-3xl font-bold mb-4">Library Admin</h1>

  <!-- Navigation -->
  <div class="flex justify-end mb-4">
    <a href="index.html" class="btn">Go to Home</a>
  </div>

  <!-- Upload Section -->
  <div class="mb-6">
    <label class="block mb-2 font-semibold">Upload ZIP Template / Page / Block / Theme / Subscription</label>
    <input type="file" id="fileInput">
    <label class="block mt-2 mb-2 font-semibold">Optional Thumbnail (Image)</label>
    <input type="file" id="thumbnailInput" accept="image/*">
    <button id="uploadBtn" class="btn mt-2">Add to Library</button>
  </div>

  <!-- Library Grid -->
  <div id="libraryGrid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6"></div>

<script>
const fileInput = document.getElementById('fileInput');
const thumbnailInput = document.getElementById('thumbnailInput');
const uploadBtn = document.getElementById('uploadBtn');
const libraryGrid = document.getElementById('libraryGrid');

// Render library from database
async function renderLibrary() {
  libraryGrid.innerHTML = '';

  try {
    const res = await fetch('/api/library/all');
    if (!res.ok) throw new Error('Failed to fetch library');
    const library = await res.json();

    const categories = {};
    library.forEach(item => {
      if (!categories[item.type]) categories[item.type] = [];
      categories[item.type].push(item);
    });

    Object.keys(categories).forEach(type => {
      const title = document.createElement('h3');
      title.textContent = type.charAt(0).toUpperCase() + type.slice(1) + 's';
      libraryGrid.appendChild(title);

      categories[type].forEach(item => {
        const card = document.createElement('div');
        card.className = "border p-4 rounded shadow flex flex-col items-center";

        // Thumbnail
        const img = document.createElement('img');
        img.src = item.thumbnail ? `data:image/png;base64,${item.thumbnail}` : 'https://via.placeholder.com/400x200?text=No+Thumbnail';
        img.className = "card-img mb-2";
        card.appendChild(img);

        // Name
        const name = document.createElement('p');
        name.textContent = item.name;
        name.className = "font-semibold mb-2 text-center";
        card.appendChild(name);

        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.className = 'btn-red';
        deleteBtn.onclick = async () => {
          if (confirm(`Are you sure you want to delete "${item.name}"?`)) {
            const delRes = await fetch(`/api/library/delete/${item.id}`, { method: 'DELETE' });
            if (delRes.ok) renderLibrary();
            else alert('Failed to delete item.');
          }
        };
        card.appendChild(deleteBtn);

        libraryGrid.appendChild(card);
      });
    });

  } catch (err) {
    console.error('Failed to load library', err);
  }
}

// Upload Handler
uploadBtn.onclick = async () => {
  if (!fileInput.files.length) return alert('Select a file!');

  const formData = new FormData();
  formData.append('file', fileInput.files[0]);
  formData.append('name', fileInput.files[0].name);
  formData.append('type', 'template'); // Default type, can add selector later
  if (thumbnailInput.files[0]) formData.append('thumbnail', thumbnailInput.files[0]);

  try {
    const res = await fetch('/api/library/upload', {
      method: 'POST',
      body: formData
    });

    const data = await res.json();
    if (data.success) {
      alert('Uploaded successfully!');
      fileInput.value = '';
      thumbnailInput.value = '';
      renderLibrary();
    } else {
      alert('Upload failed: ' + (data.error || 'Unknown error'));
    }

  } catch (err) {
    console.error('Upload error', err);
    alert('Upload failed');
  }
};

// Initial render
renderLibrary();
</script>

</body>
</html>
